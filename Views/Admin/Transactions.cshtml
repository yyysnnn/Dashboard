@{
    ViewData["Title"] = "交易記錄";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div id="transactionsApp">
    <div class="admin-card">
        <div class="card-header-custom">
            <h3><i class="bi bi-receipt"></i> 交易記錄</h3>
            <div>
                <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" v-model="selectedStore" @@change="loadTransactions">
                    <option value="">所有店舖</option>
                    <option v-for="store in stores" :key="store.id" :value="store.id">{{ store.name }}</option>
                </select>
                <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" v-model="selectedYear" @@change="loadTransactions">
                    <option v-for="year in availableYears" :key="year" :value="year">{{ year }} 年</option>
                </select>
                <select class="form-select form-select-sm d-inline-block" style="width: auto;" v-model="selectedMonth" @@change="loadTransactions">
                    <option v-for="month in 12" :key="month" :value="month">{{ month }} 月</option>
                </select>
                <span class="text-muted ms-3">共 {{ transactions.length }} 筆交易</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>交易編號</th>
                        <th>時間</th>
                        <th>店舖</th>
                        <th>金額</th>
                        <th>來客數</th>
                        <th>消費人數</th>
                    </tr>
                </thead>
                <tbody v-if="transactions.length > 0">
                    <tr v-for="trans in transactions" :key="trans.id">
                        <td><span class="badge bg-secondary">{{ trans.id }}</span></td>
                        <td>{{ formatDateTime(trans.time) }}</td>
                        <td>{{ trans.storeName }}</td>
                        <td class="text-success fw-bold">${{ formatNumber(trans.amount) }}</td>
                        <td>{{ trans.numOfCustomers }}</td>
                        <td>{{ trans.numOfConsumers }}</td>
                    </tr>
                </tbody>
                <tbody v-else>
                    <tr>
                        <td colspan="6" class="text-center text-muted">載入中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="js/vue.global.js"></script>
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                const today = new Date();
                return {
                    transactions: [],
                    stores: [],
                    selectedStore: '',
                    selectedYear: today.getFullYear(),
                    selectedMonth: today.getMonth() + 1,
                    availableYears: []
                };
            },
            created() {
                // 生成年份選項（從2024到當前年份+1）
                const currentYear = new Date().getFullYear();
                for (let year = 2024; year <= currentYear + 1; year++) {
                    this.availableYears.push(year);
                }
            },
            async mounted() {
                await this.loadStores();
                this.loadTransactions();
            },
            methods: {
                async loadStores() {
                    try {
                        const response = await fetch('@Url.Content("~/Admin/GetStores")');
                        const result = await response.json();

                        if (result.success) {
                            this.stores = result.stores;
                            // 預設選擇北屯旗艦店
                            const beitunStore = this.stores.find(s => s.name.includes('北屯旗艦店'));
                            if (beitunStore) {
                                this.selectedStore = beitunStore.id;
                            }
                        }
                    } catch (error) {
                        console.error('載入店舖資料失敗:', error);
                    }
                },
                async loadTransactions() {
                    try {
                        let url = `@Url.Content("~/Admin/GetRecentTransactions")?year=${this.selectedYear}&month=${this.selectedMonth}`;
                        if (this.selectedStore) {
                            url += `&storeId=${this.selectedStore}`;
                        }

                        const response = await fetch(url);
                        const result = await response.json();

                        if (result.success) {
                            this.transactions = result.transactions;
                        }
                    } catch (error) {
                        console.error('載入交易資料失敗:', error);
                    }
                },
                formatNumber(value) {
                    if (!value && value !== 0) return '0';
                    return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                },
                formatDateTime(dateString) {
                    if (!dateString) return '';

                    const date = new Date(dateString);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');

                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                }
            }
        }).mount('#transactionsApp');
    </script>
}
